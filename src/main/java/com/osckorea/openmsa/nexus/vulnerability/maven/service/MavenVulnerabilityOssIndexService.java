package com.osckorea.openmsa.nexus.vulnerability.maven.service;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.stream.Stream;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import com.osckorea.openmsa.nexus.vulnerability.common.dto.ComponentDto;
import com.osckorea.openmsa.nexus.vulnerability.common.dto.VulnerabilityReportDto;
import com.osckorea.openmsa.nexus.vulnerability.common.dto.types.Component;
import com.osckorea.openmsa.nexus.vulnerability.common.dto.types.VulnerabilityReport;
import com.osckorea.openmsa.nexus.vulnerability.common.feign.ComponentFeignClient;
import com.osckorea.openmsa.nexus.vulnerability.common.feign.VulnerabilityAuthFeignClient;
import com.osckorea.openmsa.nexus.vulnerability.common.feign.VulnerabilityFeignClient;
import com.osckorea.openmsa.nexus.vulnerability.maven.domain.MavenVulnerabilityDetail;
import com.osckorea.openmsa.nexus.vulnerability.maven.domain.MavenVulnerabilityDetailPrimaryKey;
import com.osckorea.openmsa.nexus.vulnerability.maven.domain.MavenVulnerabilityHeader;
import com.osckorea.openmsa.nexus.vulnerability.maven.repository.MavenVulnerabilityDetailRepository;
import com.osckorea.openmsa.nexus.vulnerability.maven.repository.MavenVulnerabilityHeaderRepository;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class MavenVulnerabilityOssIndexService {
    // CVSS Score의 위험도 단계 별 점수 기준입니다.
    private static final Integer VULNERABILITY_CRITICAL_CVSS_SCORE = 7;     // Critical Vulnerability CVSS Score 기준 점수
    private static final Integer VULNERABILITY_SEVERE_CVSS_SCORE = 4;       // Severe Vulnerability CVSS Score 기준 점수

    // 기존 Database에 저장되어있는 취약점 보고서에 대한 갱신 주기 설정 값입니다.
    private static final Integer REFRESH_POLICY_VULNERABILITY_REPORT = 7;  // 해당 일이 지나면, 새롭게 OSS Index에서 호출된 정보로 갱신합니다.

    private final ComponentFeignClient componentFeignClient;

    private final VulnerabilityFeignClient vulnerabilityFeignClient;
    private final VulnerabilityAuthFeignClient vulnerabilityAuthFeignClient;

    private final MavenVulnerabilityDetailRepository mavenVulnerabilityDetailRepository;
    private final MavenVulnerabilityHeaderRepository mavenVulnerabilityHeaderRepository;

    /**
     * SonaType OSS Index API를 호출합니다.
     * 
     * @param group : Component의 GroupId입니다.
     * @param name : Component의 Name입니다.
     * @param version : Component의 Version입니다.
     * 
     * @return 특정 Component에 대한 취약점 정보 목록을 반환합니다.
     */
    @Transactional
    public VulnerabilityReportDto.Response getComponentVulnerability(String group, String name, String version) {
        VulnerabilityReportDto.Request request = VulnerabilityReportDto.Request.builder().coordinates(new String[] {this.convertToPackageUrl(group, name, version)}).build();

        VulnerabilityReportDto.Response response = this.vulnerabilityFeignClient.getComponentVulnerabilityReports(request)[0];

        if(response.getVulnerabilities().length > 0) {
            Integer criticalCount = 0;
            Integer severeCount = 0;
            Integer moderateCount = 0;

            for(VulnerabilityReport report : response.getVulnerabilities()) {
                MavenVulnerabilityDetailPrimaryKey primaryKey = MavenVulnerabilityDetailPrimaryKey.builder().componentPackageUrl(response.getCoordinates()).id(report.getId()).build();
    
                MavenVulnerabilityDetail detailData = MavenVulnerabilityDetail.builder()
                                                                    .primaryKey(primaryKey)
                                                                    .displayName(report.getDisplayName())
                                                                    .title(report.getTitle())
                                                                    .descripton(report.getTitle())
                                                                    .cvssScore(report.getCvssScore())
                                                                    .cvssVector(report.getCvssVector())
                                                                    .cwe(report.getCwe())
                                                                    .cve(report.getCve())
                                                                    .referenceUrl(report.getReference())
                                                                    .externalReferenceUrl(report.getExternalReferences())
                                                                    .build();
                                                    
                if(report.getCvssScore() >= VULNERABILITY_CRITICAL_CVSS_SCORE) {
                    criticalCount++;
                } else if(report.getCvssScore() >= VULNERABILITY_SEVERE_CVSS_SCORE) {
                    severeCount++;
                } else {
                    moderateCount++;
                }

                this.mavenVulnerabilityDetailRepository.findByPrimaryKey(primaryKey).orElseGet(() -> this.mavenVulnerabilityDetailRepository.save(detailData));
            }

            MavenVulnerabilityHeader headerData = MavenVulnerabilityHeader.builder()
                                                                .componentPackageUrl(response.getCoordinates())
                                                                .componentDescription(response.getDescription())
                                                                .componentReferenceUrl(response.getReference())
                                                                .vulnerabilityCriticalCount(criticalCount)
                                                                .vulnerabilitySevereCount(severeCount)
                                                                .vulnerabilityModerateCount(moderateCount)
                                                                .build();

            this.mavenVulnerabilityHeaderRepository.findById(response.getCoordinates()).ifPresentOrElse(data -> {
                if(calcDiffDays(data.getLastModifiedDate().getTime(), new Date(System.currentTimeMillis()).getTime())) {
                    headerData.setNew(false);
    
                    this.mavenVulnerabilityHeaderRepository.save(headerData);
                }
            }, () -> this.mavenVulnerabilityHeaderRepository.save(headerData));
        }

        return response;
    }

    /**
     * 사용자 권한을 인증한 SonaType OSS Index API를 호출합니다.
     * 
     * @param basicAuthToken : Basic Auth 방식의 토큰 문자열입니다. ex) Basic {username}:{password}
     * @param group : Component의 GroupId입니다.
     * @param name : Component의 Name입니다.
     * @param version : Component의 Version입니다.
     * 
     * @return 특정 Component에 대한 취약점 정보 목록을 반환합니다.
     */
    @Transactional
    public VulnerabilityReportDto.Response getComponentVulnerabilityWithAuth(String basicAuthToken, String group, String name, String version) {
        VulnerabilityReportDto.Request request = VulnerabilityReportDto.Request.builder().coordinates(new String[] {this.convertToPackageUrl(group, name, version)}).build();

        VulnerabilityReportDto.Response response = this.vulnerabilityAuthFeignClient.getComponentVulnerabilityReports(basicAuthToken, request)[0];

        if(response.getVulnerabilities().length > 0) {
            Integer criticalCount = 0;
            Integer severeCount = 0;
            Integer moderateCount = 0;

            for(VulnerabilityReport report : response.getVulnerabilities()) {
                MavenVulnerabilityDetailPrimaryKey primaryKey = MavenVulnerabilityDetailPrimaryKey.builder().componentPackageUrl(response.getCoordinates()).id(report.getId()).build();
    
                MavenVulnerabilityDetail detailData = MavenVulnerabilityDetail.builder()
                                                                    .primaryKey(primaryKey)
                                                                    .displayName(report.getDisplayName())
                                                                    .title(report.getTitle())
                                                                    .descripton(report.getTitle())
                                                                    .cvssScore(report.getCvssScore())
                                                                    .cvssVector(report.getCvssVector())
                                                                    .cwe(report.getCwe())
                                                                    .cve(report.getCve())
                                                                    .referenceUrl(report.getReference())
                                                                    .externalReferenceUrl(report.getExternalReferences())
                                                                    .build();
                                                    
                if(report.getCvssScore() >= VULNERABILITY_CRITICAL_CVSS_SCORE) {
                    criticalCount++;
                } else if(report.getCvssScore() >= VULNERABILITY_SEVERE_CVSS_SCORE) {
                    severeCount++;
                } else {
                    moderateCount++;
                }

                // 현재 Detail Data가 있는지 검사하고 없으면, 저장용 목록에 추가합니다.
                this.mavenVulnerabilityDetailRepository.findByPrimaryKey(primaryKey).orElseGet(() -> this.mavenVulnerabilityDetailRepository.save(detailData));
            }

            MavenVulnerabilityHeader headerData = MavenVulnerabilityHeader.builder()
                                                                .componentPackageUrl(response.getCoordinates())
                                                                .componentDescription(response.getDescription())
                                                                .componentReferenceUrl(response.getReference())
                                                                .vulnerabilityCriticalCount(criticalCount)
                                                                .vulnerabilitySevereCount(severeCount)
                                                                .vulnerabilityModerateCount(moderateCount)
                                                                .build();

            this.mavenVulnerabilityHeaderRepository.findById(response.getCoordinates()).ifPresentOrElse(data -> {
                if(calcDiffDays(data.getLastModifiedDate().getTime(), new Date(System.currentTimeMillis()).getTime())) {
                    headerData.setNew(false);
    
                    this.mavenVulnerabilityHeaderRepository.save(headerData);
                }
            }, () -> this.mavenVulnerabilityHeaderRepository.save(headerData));
        }

        return response;
    }

    @Transactional
    public List<VulnerabilityReportDto.Response> getComponentVulnerabilities(String name) {
        ArrayList<String> componetPackageUrlList = new ArrayList<String>();
        ArrayList<VulnerabilityReportDto.Response> vulnerabilityReportList = new ArrayList<VulnerabilityReportDto.Response>();

        VulnerabilityReportDto.Request vulnerabilityRequestData = null;

        ArrayList<MavenVulnerabilityHeader> headerDataList = new ArrayList<MavenVulnerabilityHeader>();
        ArrayList<MavenVulnerabilityDetail> detailDataList = new ArrayList<MavenVulnerabilityDetail>();

        ComponentDto componentList = this.componentFeignClient.getComponentList(name);

        while(componentList.getContinuationToken() != null) {
            // Component 120개에 대한 PackageUrl 목록을 추가합니다.
            while(componentList.getContinuationToken() != null & componetPackageUrlList.size() < 120) {

                for (Component component : componentList.getItems()) {
                    componetPackageUrlList.add(convertToPackageUrl(component.getGroup(), component.getName(), component.getVersion()));
                }

                componentList = this.componentFeignClient.getComponentList(componentList.getContinuationToken(), name);
            }

            // 120개의 Component 목록에 대하여, 취약점 목록 요청 API에 전송할, Body Data를 생성합니다.
            vulnerabilityRequestData = VulnerabilityReportDto.Request.builder().coordinates(componetPackageUrlList.toArray(String[]::new)).build();

            // 취약점 목록
            VulnerabilityReportDto.Response[] vulnerabilityResponse = this.vulnerabilityFeignClient.getComponentVulnerabilityReports(vulnerabilityRequestData);

            Stream.of(vulnerabilityResponse)
                    .parallel()
                    .filter(report -> report.getVulnerabilities().length > 0)
                    .forEach(report -> {
                        vulnerabilityReportList.add(report);

                        Integer criticalCount = 0;
                        Integer severeCount = 0;
                        Integer moderateCount = 0;

                        for (VulnerabilityReport data :report.getVulnerabilities()) {
                            MavenVulnerabilityDetailPrimaryKey primaryKey = MavenVulnerabilityDetailPrimaryKey.builder().componentPackageUrl(report.getCoordinates()).id(data.getId()).build();

                            MavenVulnerabilityDetail detailData = MavenVulnerabilityDetail.builder()
                                                                                .primaryKey(primaryKey)
                                                                                .displayName(data.getDisplayName())
                                                                                .title(data.getTitle())
                                                                                .descripton(data.getDescription())
                                                                                .cvssScore(data.getCvssScore())
                                                                                .cvssVector(data.getCvssVector())
                                                                                .cwe(data.getCwe())
                                                                                .cve(data.getCve())
                                                                                .referenceUrl(data.getReference())
                                                                                .externalReferenceUrl(data.getExternalReferences())
                                                                                .build();

                            if (data.getCvssScore() >= VULNERABILITY_CRITICAL_CVSS_SCORE) {
                                criticalCount++;
                            } else if(data.getCvssScore() >= VULNERABILITY_SEVERE_CVSS_SCORE) {
                                severeCount++;
                            } else {
                                moderateCount++;
                            }

                            if (this.mavenVulnerabilityDetailRepository.findByPrimaryKey(primaryKey).isEmpty()) {
                                detailDataList.add(detailData);
                            }
                        }

                        MavenVulnerabilityHeader headerData = MavenVulnerabilityHeader.builder()
                                                                            .componentPackageUrl(report.getCoordinates())
                                                                            .componentDescription(report.getDescription() != null ? report.getDescription() : "")
                                                                            .componentReferenceUrl(report.getReference())
                                                                            .vulnerabilityCriticalCount(criticalCount)
                                                                            .vulnerabilitySevereCount(severeCount)
                                                                            .vulnerabilityModerateCount(moderateCount)
                                                                            .build();

                        this.mavenVulnerabilityHeaderRepository.findById(report.getCoordinates()).ifPresentOrElse(data -> {
                            if(calcDiffDays(data.getLastModifiedDate().getTime(), new Date(System.currentTimeMillis()).getTime())) {
                                headerData.setNew(false);

                                headerDataList.add(headerData);
                            } 
                        }, () -> headerDataList.add(headerData));
                    });
            
            this.mavenVulnerabilityHeaderRepository.saveAll(headerDataList);
            this.mavenVulnerabilityDetailRepository.saveAll(detailDataList);

            componetPackageUrlList.clear();
            headerDataList.clear();
            detailDataList.clear();
        }

        return vulnerabilityReportList;
    }

    @Transactional
    public List<VulnerabilityReportDto.Response> getComponentVulnerabilitiesWithAuth(String basicAuthToken, String name) {
        ArrayList<String> componetPackageUrlList = new ArrayList<String>();
        ArrayList<VulnerabilityReportDto.Response> vulnerabilityReportList = new ArrayList<VulnerabilityReportDto.Response>();

        VulnerabilityReportDto.Request vulnerabilityRequestData = null;

        ArrayList<MavenVulnerabilityHeader> headerDataList = new ArrayList<MavenVulnerabilityHeader>();
        ArrayList<MavenVulnerabilityDetail> detailDataList = new ArrayList<MavenVulnerabilityDetail>();

        ComponentDto componentList = this.componentFeignClient.getComponentList(name);

        while(componentList.getContinuationToken() != null) {
            // Component 120개에 대한 PackageUrl 목록을 추가합니다.
            while(componentList.getContinuationToken() != null & componetPackageUrlList.size() < 120) {

                for (Component component : componentList.getItems()) {
                    componetPackageUrlList.add(convertToPackageUrl(component.getGroup(), component.getName(), component.getVersion()));
                }

                componentList = this.componentFeignClient.getComponentList(componentList.getContinuationToken(), name);
            }

            // 120개의 Component 목록에 대하여, 취약점 목록 요청 API에 전송할, Body Data를 생성합니다.
            vulnerabilityRequestData = VulnerabilityReportDto.Request.builder().coordinates(componetPackageUrlList.toArray(String[]::new)).build();

            // 취약점 목록
            VulnerabilityReportDto.Response[] vulnerabilityResponse = this.vulnerabilityAuthFeignClient.getComponentVulnerabilityReports(basicAuthToken, vulnerabilityRequestData);

            Stream.of(vulnerabilityResponse)
                    .parallel()
                    .filter(report -> report.getVulnerabilities().length > 0)
                    .forEach(report -> {
                        vulnerabilityReportList.add(report);

                        Integer criticalCount = 0;
                        Integer severeCount = 0;
                        Integer moderateCount = 0;

                        for (VulnerabilityReport data :report.getVulnerabilities()) {
                            MavenVulnerabilityDetailPrimaryKey primaryKey = MavenVulnerabilityDetailPrimaryKey.builder().componentPackageUrl(report.getCoordinates()).id(data.getId()).build();

                            MavenVulnerabilityDetail detailData = MavenVulnerabilityDetail.builder()
                                                                                .primaryKey(primaryKey)
                                                                                .displayName(data.getDisplayName())
                                                                                .title(data.getTitle())
                                                                                .descripton(data.getDescription())
                                                                                .cvssScore(data.getCvssScore())
                                                                                .cvssVector(data.getCvssVector())
                                                                                .cwe(data.getCwe())
                                                                                .cve(data.getCve())
                                                                                .referenceUrl(data.getReference())
                                                                                .externalReferenceUrl(data.getExternalReferences())
                                                                                .build();

                            if (data.getCvssScore() >= VULNERABILITY_CRITICAL_CVSS_SCORE) {
                                criticalCount++;
                            } else if(data.getCvssScore() >= VULNERABILITY_SEVERE_CVSS_SCORE) {
                                severeCount++;
                            } else {
                                moderateCount++;
                            }

                            if (this.mavenVulnerabilityDetailRepository.findByPrimaryKey(primaryKey).isEmpty()) {
                                detailDataList.add(detailData);
                            }
                        }

                        MavenVulnerabilityHeader headerData = MavenVulnerabilityHeader.builder()
                                                                            .componentPackageUrl(report.getCoordinates())
                                                                            .componentDescription(report.getDescription())
                                                                            .componentReferenceUrl(report.getReference())
                                                                            .vulnerabilityCriticalCount(criticalCount)
                                                                            .vulnerabilitySevereCount(severeCount)
                                                                            .vulnerabilityModerateCount(moderateCount)
                                                                            .build();

                        this.mavenVulnerabilityHeaderRepository.findById(report.getCoordinates()).ifPresentOrElse(data -> {
                            if(calcDiffDays(data.getLastModifiedDate().getTime(), new Date(System.currentTimeMillis()).getTime())) {
                                headerData.setNew(false);

                                headerDataList.add(headerData);
                            } 
                        }, () -> headerDataList.add(headerData));
                    });
            
            this.mavenVulnerabilityHeaderRepository.saveAll(headerDataList);
            this.mavenVulnerabilityDetailRepository.saveAll(detailDataList);

            componetPackageUrlList.clear();
            headerDataList.clear();
            detailDataList.clear();
        }

        return vulnerabilityReportList;
    }

    /**
     * PackageURL 문자열로 변환합니다.
     * 
     * @param componentGroup : 컴포넌트 그룹 명
     * @param componentName : 컴포넌트 이름
     * @param componentVersion : 컴포넌트 버전
     * 
     * @return "pkg:maven/{componentGroup}/{componentName}@{componentVersion}"
     */
    private String convertToPackageUrl(String componentGroup, String componentName, String componentVersion) {
        StringBuilder componentVulnerabilityRequestData = new StringBuilder("pkg:maven");

        componentVulnerabilityRequestData.append("/");
        componentVulnerabilityRequestData.append(componentGroup);
        componentVulnerabilityRequestData.append("/");
        componentVulnerabilityRequestData.append(componentName);
        componentVulnerabilityRequestData.append("@");
        componentVulnerabilityRequestData.append(componentVersion);

        return componentVulnerabilityRequestData.toString();
    }

    /**
     * 파라미터로 입력된 사용자 명과 비밀번호를 Basic Auth Token으로 변환합니다.
     * 
     * @param username : SonaType OSS Index 사용자 이메일
     * @param password : SonaType OSS Index 사용자 API Token
     * 
     * @return "Basic {username:password :: StringToBase64}"
     */
    // private String convertBasicAuthToken(String username, String password) {
    //     return "Basic " + Base64.getEncoder().encodeToString(String.join(":", username, password).getBytes()).toString();
    // }

    /**
     * 파라미터로 입력된 두 시간 사이의 날짜를 계산합니다.
     * 
     * @param targetDateToSecond
     * @param compareDateToSecond
     * 
     * @return TRUE or FALSE
     */
    private Boolean calcDiffDays(Long targetDateToSecond, Long compareDateToSecond) {
        Long diffDays = ((targetDateToSecond - compareDateToSecond) - 1000 ) / (24 * 60 * 60);

        if(diffDays >= REFRESH_POLICY_VULNERABILITY_REPORT) {
            return true;
        } else {
            return false;
        }
    }
}

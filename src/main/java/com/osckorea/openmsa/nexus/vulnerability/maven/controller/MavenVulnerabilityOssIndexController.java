package com.osckorea.openmsa.nexus.vulnerability.maven.controller;

import java.util.List;
import javax.servlet.http.HttpServletRequest;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.osckorea.openmsa.nexus.vulnerability.common.dto.VulnerabilityReportDto;
import com.osckorea.openmsa.nexus.vulnerability.maven.service.MavenVulnerabilityOssIndexService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;



@Tag(name = "Component 취약점 점검 API")
@RestController
@RequestMapping("v1")
@RequiredArgsConstructor
public class MavenVulnerabilityOssIndexController {
    private final MavenVulnerabilityOssIndexService mavenVulnerabilityOssIndexService;

    @Operation(summary = "특정 Component 취약점 점검 요청 API")
    @GetMapping("vulnerability/maven")
    public VulnerabilityReportDto.Response getOssIndexComponentVulnerabilityInfo(
        @RequestParam("group") String group,
        @RequestParam("name") String name,
        @RequestParam("version") String version) {
        return this.mavenVulnerabilityOssIndexService.getComponentVulnerability(group, name, version);
    }

    @Operation(summary = "저장소에 포함 된 모든 Component의 취약점 점검 요청 API")
    @GetMapping("vulnerability/maven/{repositoryName}")
    public List<VulnerabilityReportDto.Response> getComponentVulnerabilities(@PathVariable("repositoryName") String name) {
        return this.mavenVulnerabilityOssIndexService.getComponentVulnerabilities(name);
    }
    
    @Operation(summary = "사용자 계정 정보로 특정 Component 취약점 점검 요청 API")
    @GetMapping(value = "vulnerability/authorized/maven", params = {"group", "name", "version"})
    public VulnerabilityReportDto.Response getComponentVulnerabilityReport(
        HttpServletRequest request,
        @RequestParam("group") String group,
        @RequestParam("name") String name,
        @RequestParam("version") String version 
    ) {
        return this.mavenVulnerabilityOssIndexService.getComponentVulnerabilityWithAuth(request.getHeader("Authorization"), group, name, version);
    }

    @Operation(summary = "사용자 계정 정보로 저장소에 포함 된 모든 Component의 취약점 점검 요청 API")
    @GetMapping(value = "vulnerability/authorized/maven/{repositoryName}")
    public List<VulnerabilityReportDto.Response> getComponentVulnerabilityReports(
        HttpServletRequest request,
        @PathVariable("repositoryName") String name
    ) {
        return this.mavenVulnerabilityOssIndexService.getComponentVulnerabilitiesWithAuth(request.getHeader("Authorization"), name);
    }
}
